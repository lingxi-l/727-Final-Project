---
title: "727 Final Project"
author: "Lingxi Li"
date: "10/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(xml2)
library(rvest)
library(robotstxt)
library(tidyverse)
library(magrittr)
library(ggplot2)
```
Test if web scraping is allowed
```{r}
paths_allowed("https://www.goodreads.com/shelf/show/race?page=1")
```
Use page2 as an example to prepare for the loop below
```{r}
#Read resut from web
url <- read_html("https://www.goodreads.com/shelf/show/race?page=2")
```
extract text including publish year
```{r}
nds <- html_nodes(url, xpath = '//*[contains(concat( " ", @class, " " ), concat( " ", "greyText", " " )) and contains(concat( " ", @class, " " ), concat( " ", "smallText", " " ))]')
```
extract further from list
```{r}
#transfer into dataframe
pub_yr <- html_text(nds)
pub_yr<-as.data.frame(pub_yr)
head(pub_yr)
#extract the year
pub_yr %<>% 
  separate(pub_yr,c("rating","num_ra","year"),"—") %>%
  separate(year,c("xxx","year"),"published")
#trim line breaker
trimws(pub_yr$year,which="both")
```
This web requires login to loop through all pages
```{r}
#Address of the login webpage
login<-"https://www.goodreads.com/user/sign_in?returnurl=%2Fshelf%2Fshow%2Frace%3Fpage%3D1"

#create a web session with the desired login address
pgsession<-html_session(login)
pgform<-html_form(pgsession)[[1]] #in this case the submit is the 1st form
filled_form<-set_values(pgform,'user[email]'="***", 'user[password]'= "***")
submit_form(pgsession, filled_form)
```
create loop
```{r}
PAGE<-25
f_pubyr<-data.frame()

for (i in 1:PAGE) {
  url <- paste0("https://www.goodreads.com/shelf/show/race?page=",i)
  print(url)
  page<-jump_to(pgsession, url)
  nds <- html_nodes(page, xpath = '//*[contains(concat( " ", @class, " " ), concat( " ", "greyText", " " )) and contains(concat( " ", @class, " " ), concat( " ", "smallText", " " ))]')
  pub_yr <- html_text(nds)
  pub_yr<-as.data.frame(pub_yr)
  f_pubyr<-rbind(f_pubyr,pub_yr)
}
```
clean the data for "publish year" of book about race
```{r}
#view the first 6 rows
head(f_pubyr)
#remove irrelevant rows (all irrelavent rows contains ")")
a<-as.vector(f_pubyr$pub_yr)
length(which(grepl(")",a)==TRUE)) #1308-58 is exactly 1250, the number of rows of clean data
f_pubyr %<>% filter(grepl(")",a)==FALSE)
#extract the year
f_pubyr %<>% 
  separate(pub_yr,c("rating","num_ra","year"),"—") %>%
  separate(year,c("xxx","year"),"published")  #all "missing pieces" from the warning message is the text misscraped that does not include "publish year"
#trim line breaker
f_pubyr$tyear<-trimws(f_pubyr$year,which="both")
#remove irrelevant columns
f_pubyr <- f_pubyr[,c(-3,-4)]
```
Now we have a single column "year" that contains all the "publish year"
```{r}
#breifly check the value of variable "year" 
table(f_pubyr$tyear,exclude=NULL) 
                    #29 missing because of incomplete text online                            
                    #since frequency before 1960 all less than 3

#bar chart: Number of books about race per year
#filter out NA and blank
f_pubyr %<>% filter(tyear!="" & is.na(tyear)==FALSE & tyear>=1960)
ggplot(f_pubyr,aes(tyear))+
  geom_bar()+
  theme(axis.text.x = element_text(angle = 90))
```
clean the data for "rating" of book about race
```{r}
#trim line breaker
f_pubyr$rating<-trimws(f_pubyr$rating,which="both")
#extract number of rating from column "rating"
f_pubyr$rating<-substr(f_pubyr$rating,12,15)
```
Now we have a single column "rating"
```{r}
#check value
table(f_pubyr$rating,exclude=NULL)
#bar chart: Average rating of books about race by year
rate<-f_pubyr %>%
  group_by(tyear) %>%
  summarise(mean(as.numeric(rating))) 
colnames(rate)[2]<-"rating"
ggplot(rate,aes(x=tyear,y=rating))+
  geom_bar(stat="identity")+
  coord_cartesian(ylim = c(3.75, 4.5))+
  theme(axis.text.x = element_text(angle = 90))
```
Run another loop to get book names
```{r}
PAGE<-25
f_rana<-data.frame()

for (i in 1:PAGE) {
  url <- paste0("https://www.goodreads.com/shelf/show/race?page=",i)
  print(url)
  page <- jump_to(pgsession, url)
  nds <- html_nodes(page, xpath = '//*[contains(concat( " ", @class, " " ), concat( " ", "bookTitle", " " ))]')
  race_name <- html_text(nds)
  race_name <- as.data.frame(race_name)
  f_rana <- rbind(f_rana,race_name)
}
```
put name and year in the same dataframe
```{r}
f_race <- cbind(f_rana, f_pubyr)
```


